@using ContentModels = Umbraco.Cms.Web.Common.PublishedModels
@using Umbraco.Extensions
@using System.Net.Http
@using System.Xml.Linq
@using Microsoft.AspNetCore.Mvc 
@inject INewsFeedService NewsService
@inherits Umbraco.Cms.Web.Common.Views.UmbracoViewPage<ContentModels.ExternalNewsPage>
@{
    Layout = "master.cshtml";
}

@Html.Partial("~/Views/Partials/SectionHeader.cshtml")
<section class="section">
    <div class="container">
        <div class="col-md-12">
            <article>
                @await Html.GetBlockGridHtmlAsync(Model, "bodyText")
            </article>
            <div class="news-container">
                @{
                    var feedUrl = Model.Value<string>("sourceUrl");
                    var newsItems = await NewsService.GetNewsItemsAsync(feedUrl);  // Async call, regarldess of load time for news items, page will still load
                }
                @if (newsItems.Any())
                {
                    @foreach (var item in newsItems)
                    {
                        var title = item.Element("title")?.Value ?? "Untitled Article";
                        var description = item.Element("description")?.Value ?? string.Empty;
                        var truncatedDesc = description.Length > 100 ? description.Substring(0, 100) + "..." : description;
                        var pubDateStr = item.Element("pubDate")?.Value ?? "2025-01-01T00:00:00Z";
                        DateTime pubDate;
                        try { pubDate = DateTime.Parse(pubDateStr); }
                        catch { pubDate = DateTime.Parse("2025-01-01T00:00:00Z"); }
                        var formattedDate = DateHelper.ToOrdinalDate(pubDate); 
                        var link = item.Element("link")?.Value ?? "#";
                        var image = item.Element("image")?.Value ?? "/images/300.jpg"; 
                        
                        <article class="news-item">
                            <img src="@image" alt="@title" loading="lazy"> 
                            <div class="news-content">
                                <h2>@title</h2>
                                <p class="date">@formattedDate</p>
                                <p>@Html.Raw(truncatedDesc)</p>
                                <a href="@link" class="read-more" target="_blank" rel="noopener">read more</a>
                            </div>
                        </article>
                    }
                }
                else
                {
                    <p>No news articles available at this time. Please check the feed source.</p>
                }
            </div>
        </div>
    </div>
</section>

<link rel="stylesheet" href="@Url.Content("~/css/umbraco-starterkit-blockgrid.css")" />
<link rel="stylesheet" href="@Url.Content("~/css/newslist.css")" />